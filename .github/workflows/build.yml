on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

jobs:
  versiontag:
    runs-on: arc-runner-set
    if: github.ref != 'refs/heads/main'
    steps:
      - uses: actions/checkout@v5
      - name: Check version tag
        run: |
          curl -f https://raw.githubusercontent.com/pvarki/docker-rasenmaeher-integration/main/version.yml -o /tmp/main_version.yml || touch /tmp/main_version.yml
          diff /tmp/main_version.yml ./version.yml && exit 1 || exit 0

  apiunits:
    runs-on: arc-runner-set
    permissions:
      contents: write
      pull-requests: write
      checks: write
    strategy:
      matrix:
        python-version: ["3.11"] # , "3.12"]
    env:
      PIP_INDEX_URL: https://nexus.dev.pvarki.fi/repository/python/simple
      POETRY_PYPI_MIRROR_URL: https://nexus.dev.pvarki.fi/repository/python/simple
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v5
        with:
          submodules: recursive
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install poetry pre-commit
          poetry self add poetry-plugin-pypi-mirror
          echo PATH=$PATH:/home/runner/.local/bin >> ${GITHUB_ENV}
          cd api && poetry install
      - name: Prep docker
        run: |
          rm -rf api/tests/data/cfssl/*
          rm -rf api/tests/data/ca_public/*
          docker system prune --all --volumes --force
          cd api/tests
          docker compose -f docker-compose.yml pull --ignore-pull-failures
          docker compose -f docker-compose.yml up -d --wait || docker compose -f docker-compose.yml logs
          docker compose -f docker-compose.yml down -v
      - name: Test with pytest
        run: |
          cd api && poetry run py.test -v --junitxml=pytest-apiunit.xml tests/
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: success() || failure() # always run even if the previous step fails
        with:
          report_paths: 'api/pytest*.xml'
          detailed_summary: true
          check_name: 'api unit tests'

  rmlocal:
    runs-on: arc-runner-set
    permissions:
      contents: write
      pull-requests: write
      checks: write
    env:
      PVARKI_DOCKER_REPO: localhost:5050/
      DOCKER_TAG_EXTRA: -rmlocaltest
    steps:
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions/checkout@v5
      with:
        submodules: recursive
    - name: install dependencies
      id: install_dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install pre-commit
        echo PATH=$PATH:/home/runner/.local/bin >> ${GITHUB_ENV}
        pip install -r tests/requirements.txt
    - name: pre-commit
      id: pre_commit
      run: |
        export SKIP=no-commit-to-branch
        source example_env.sh
        pre-commit run --all-files
    - name: local Docker registry
      run: |
          docker run -d -p 5050:5000 --restart always --name registry registry:3
    - name: docker compose build
      id: compose_build
      run: |
        shopt -s expand_aliases
        alias dcloc="docker compose -p rmlocal -f docker-compose-local.yml"
        docker system prune --all --volumes --force
        dcloc build --pull takinit miniwerk rmnginx --push
        dcloc build --pull
        dcloc pull --ignore-buildable
    - name: docker compose cleanup
      id: compose_clean_1
      run: |
        shopt -s expand_aliases
        alias dcloc="docker compose -p rmlocal -f docker-compose-local.yml"
        alias dcdev="docker compose -p rmdev -f docker-compose-local.yml -f docker-compose-dev.yml"
        dcloc down -v || true
        dcdev down -v || true
    - name: docker compose up first attempt
      id: compose_up_first
      run: |
        shopt -s expand_aliases
        alias dcloc="docker compose -p rmlocal -f docker-compose-local.yml"
        dcloc up --wait || (dcloc logs && exit 1)
      continue-on-error: true
    - name: docker compose up second attempt
      if: ${{ steps.compose_up_first.outcome == 'failure' }}
      id: compose_up_second
      run: |
        shopt -s expand_aliases
        alias dcloc="docker compose -p rmlocal -f docker-compose-local.yml"
        dcloc up --wait || (dcloc logs && exit 1)
      continue-on-error: true
    - name: add test users
      id: add_test_users
      run: |
        docker ps
        docker exec rmlocal-rmapi-1 rasenmaeher_api addtestusers
        docker exec rmlocal-rmapi-1 cat /etc/hosts
    - name: Test with pytest
      id: run_pytest
      run: |
        shopt -s expand_aliases
        alias dcloc="docker compose -p rmlocal -f docker-compose-local.yml"
        py.test -v --junitxml=pytest-rmlocal.xml tests/ || (dcloc logs && exit 1)
    - name: Publish Test Report
      uses: mikepenz/action-junit-report@v4
      if: success() || failure() # always run even if the previous step fails
      with:
        report_paths: '**/pytest*.xml'
        detailed_summary: true
        include_passed: true
        check_name: 'rmlocal integration tests'
    - name: docker compose cleanup
      id: compose_clean_2
      if: ${{ !cancelled() }}
      run: |
        shopt -s expand_aliases
        alias dcloc="docker compose -p rmlocal -f docker-compose-local.yml"
        dcloc down -v || true


  build_and_publish:
    runs-on: arc-runner-set
    needs: [apiunits, rmlocal]
    strategy:
      matrix:
        extra_env: ["none", "date"]
        asset_set: ["default", "fdf"]
    env:
      PVARKI_DOCKER_REPO: ghcr.io/
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v5
        with:
          submodules: recursive
      - name: Fix ref slashes
        run: |
          echo REF_NO_SLASHES=$(echo "${{ github.ref_name }}" | sed 's/\//-/g') >> ${GITHUB_ENV}
      - name: Set VITE_THEME
        run: |
          echo "VITE_THEME=${{ matrix.asset_set }}" >> ${GITHUB_ENV}
          cat ${GITHUB_ENV}
      - name: Set DOCKER_TAG_EXTRA if date
        run: |
          test "${{ matrix.extra_env }}" = "date" && echo "DOCKER_TAG_EXTRA=-$(date +%Y%m%d)" >> ${GITHUB_ENV} || true
          cat ${GITHUB_ENV}
      - name: Set DOCKER_TAG_EXTRA if not main
        if: github.event.pull_request.merged != true
        run: |
          test "${{ github.ref }}" = "refs/heads/main" || echo "DOCKER_TAG_EXTRA=-$REF_NO_SLASHES" >> ${GITHUB_ENV}
          cat ${GITHUB_ENV}
      - name: Build takinit and miniwerk (main)
        run: |
          source example_env.sh
          docker compose build --pull takinit miniwerk rmnginx
      - name: Build takinit and miniwerk (local)
        run: |
          docker compose -f docker-compose-local.yml build --pull takinit miniwerk rmnginx
      - name: push takinit and miniwerk
        if: ${{ !env.ACT }}
        run: |
          source example_env.sh
          docker compose push takinit miniwerk rmnginx
          docker compose -f docker-compose-local.yml push takinit miniwerk rmnginx
      - name: Build main composition (main)
        run: |
          source example_env.sh
          docker compose build --pull
      - name: Build main composition (local)
        run: |
          docker compose -f docker-compose-local.yml build --pull
      - name: Push main composition
        if: ${{ !env.ACT }}
        run: |
          source example_env.sh
          docker compose push
          docker compose -f docker-compose-local.yml push
      - name: Warm Nexus cache
        if: '!cancelled()'  # FIXME: Figure out how to check also env.ACT
        run: |
          source example_env.sh
          export PVARKI_DOCKER_REPO=group.docker.nexus.dev.pvarki.fi/
          export HUB_DOCKER_REPO=group.docker.nexus.dev.pvarki.fi/
          docker compose pull --ignore-pull-failures
          docker compose -f docker-compose-local.yml pull --ignore-pull-failures

  build_and_publish_dockerhub:
    runs-on: ubuntu-latest
    needs: [build_and_publish]
    strategy:
      matrix:
        extra_env: ["none", "date"]
        asset_set: ["default", "fdf"]
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v5
        with:
          submodules: recursive
      - name: Fix ref slashes
        run: |
          echo REF_NO_SLASHES=$(echo "${{ github.ref_name }}" | sed 's/\//-/g') >> ${GITHUB_ENV}
      - name: Set VITE_THEME
        run: |
          echo "VITE_THEME=${{ matrix.asset_set }}" >> ${GITHUB_ENV}
          cat ${GITHUB_ENV}
      - name: Set DOCKER_TAG_EXTRA if date
        run: |
          test "${{ matrix.extra_env }}" = "date" && echo "DOCKER_TAG_EXTRA=-$(date +%Y%m%d)" >> ${GITHUB_ENV} || true
          cat ${GITHUB_ENV}
      - name: Set DOCKER_TAG_EXTRA if not main
        if: github.event.pull_request.merged != true
        run: |
          test "${{ github.ref }}" = "refs/heads/main" || echo "DOCKER_TAG_EXTRA=-$REF_NO_SLASHES" >> ${GITHUB_ENV}
          cat ${GITHUB_ENV}
      - name: Pull images
        run: |
          source example_env.sh
          docker compose pull
          docker compose -f docker-compose-local.yml pull
      - name: build and push main composition to docker.io
        if: ${{ !env.ACT }}
        run: |
          source example_env.sh
          export PVARKI_DOCKER_REPO=docker.io/
          docker compose build --push takinit miniwerk rmnginx
          docker compose build --push
          docker compose -f docker-compose-local.yml build --push takinit miniwerk rmnginx
          docker compose -f docker-compose-local.yml build --push
